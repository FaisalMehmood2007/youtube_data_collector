# 実用に向けて

このドキュメントでは、YouTube API関係の知識・本コードの構成など、実用時に活かせそうな内容を説明します。




## 1日の API 使用上限（quota）について
YouTube APIには「quota」というチャージの概念があり、1日あたり10,000 quota与えられています。([公式: API概要](https://developers.google.com/youtube/v3/getting-started?hl=ja))
|`mode` (本コードでの表記)  |1リクエストあたり消費量 |[公式サイト](https://developers.google.com/youtube/v3/determine_quota_cost?hl=ja)での記載方法|1日あたりの最大取得数(※)
|---|---|---|---|
|`movie`  |100 quota  |`検索-list`|100年(月・日)分の動画|
|`comment`|1 quota  |`コメントスレッド-list`|10,000動画のコメント|
|`stats`|1 quota  |`動画-list`|10,000動画の統計量|
||
- (※)「最大取得数」は、再リクエストがない場合の取得数を表す(後述)。

#### この仕組みにより、注意すべき点は2つあります。

1. <u>**`movie`モードでは期間の指定の仕方によって、消費量が変わる**</u>

   例：2020年から2022年の2年分の動画データを取得する際の消費quota
    |`start`|`end`|消費quota|
    |---|---|---|
    |`2020`  |`2022`|最低 `100*3=300` quota消費|
    |`2020-01`|`2022-12` |最低 `100*12*3=3,600` quota消費|
    ||

    - 年・月・日を指定できる仕様なのは、なるべく大きい単位で実行し、quota効率を上げるためです。


2. <u>**検索でヒットするデータ数は、検索条件によって大きく異なる**</u>

    例：レシピ動画を探そうとしたとき...
    |`query`|ヒット数（イメージ）|再リクエスト|
    |---|---|---|
    |`レシピ`  |1,000|あり|
    |`レシピ AND キャベツ AND 豚肉 AND 時短 `|30|なし|
    ||

    - 上記の数字はイメージですが、条件を絞り込んだほうがヒット数は少なくなることは容易に想像できると思います。そして、1回のリクエストで1,000件のデータを集めることはできないので、同じ条件で何度もリクエストする必要があります。


このように、なるべく効率よくquotaを使用するのが、大量のデータを朱武州するコツとなります。ここで、「どれくらいで再リクエストするのか？」時になった方は次の章をご覧ください。

## 再リクエストについて
前章で登場したように、1回のリクエストで取得できるデータ数( `maxResults` )には上限があり、50です([公式: Search関数](https://developers.google.com/youtube/v3/docs/search/list?hl=ja))。 ただし50件を超える結果はざらにあるので、50件を超える時には「まだ続くよ」とAPIが教えてくれます( `PageToken` )。

本ライブラリではその仕組みを用いて、`PageToken`がある限り再リクエストする仕様としています。 例えば、先程の「レシピ」の例では、ヒットする動画数が1,000件なので、合計1000/50=20より20回リクエストを行います。 Twitter API等でもこの仕組みはありますが、非常に便利ですね。 ちなみに本ライブラリでは、リクエスト回数(`request_count`)を自動で表示するので参考にしてみてください。

## quotaは増やせないか？

本ライブラリは「直感的・実用的」なライブラリを目指し、限られたquota内でどう効率よくデータを収集するか、という点に重点を置いています。 一方で、quotaを増やせないの？と思う方はいらっしゃると思います。これの答えはYesで、申請により増やすことができます。
YouTubeに申請フォームを出し、承認されれば増やせるようなので、詳しくは公式やその他の方の記事をご参照ください。
しかし、私の場合は以下の3点から結局上限解除はしていません。
- 意外とステップが面倒くさい
- 上限解除に関する情報量が、あまり多くない
- 使用するquota数を申請するために本ライブラリを実装したら、自身の研究ではデータ数的に不要と気づいた

研究・サービス内容によっては上限解除申請をしたほうが良い場合も多々あると思いますので、その判断に本ライブラリでの試行結果が一助となれば幸いです。

## `mode` による違いまとめ
ここまでのまとめとして、各モードの違いを表に示します。

| `mode`    | `movie`              | `comment`          | `stats`           |
|-----------|----------------------|--------------------|-------------------|
| `args`で指定 | `query`, `channel_id` | `video_id_list`  　　　　  | `video_id_list`   |
| アウトプット    | 動画のメタデータ             | 動画のコメント            | 動画の統計量データ            |
| 保存スパン     | 期間ごと(年・月・日)          | `save_threshold`ごと| 1実行で1データ          |
| 保存名       | `キーワード_2010.csv`     | `comment_abcdefgh.csv`   | `movie_stats.csv`　 |
| リクエスト数    | `n` 回以上 (※1,2) | `video_id` 回以上 (※1)  | `video_id` 回      |
| 必要quota   | リクエスト数*100           | リクエスト数             | リクエスト数            |
| 保存ファイル数   | `n` 個(※2)     | `全コメント数/save_threshold` 個       | 1個           |

※1：再リクエストがない場合を「最低リクエスト数」とする  
※2：n年・n月・n日というように、各単位×nの期間で収集したとする

### 本コードのディレクトリ構成
```
youtube_data_collector
├── docs                # ライブラリの実行に関係する文書まとめ (英語)
│   ├── note.md         # 実行に関わる補足・注意点等
│   └── usage.md        # 詳しい使用方法
├── docs_ja             # ライブラリの実行に関係する文書まとめ (日本語)
│   ├── note_ja.md
│   └── usage.md
├── LICENSE             # ライセンス
├── README.md           # 概要
├── requirements.txt    # 依存関係
├── setup.py            # セットアップ
└── ytdc                # メインフォルダ
    ├── __init__.py
    └── main.py         # メインのコード
```
```

main.py
├── class CollectMovieData          # 動画のメタデータ収集クラス
├── class CollectCommentData        # コメントデータ収集クラス
├── class CollectMovieStatsData     # 動画の統計データ収集クラス
└── class YouTubeDataCollector      # すべてを実行するクラス (modeにより切り替え)
```

## 最後に
長くなりましたが、ここまで読んでくださり、ありがとうございます。
このライブラリが少しでも皆さんのお役に立てると幸いです。もし良かったら記事のいいね、GitHubのStar等くださると励みになります。

最後に、注意点を述べさせていただきます。  
- 本コードは、2023年12月時点で実装したものです。必要に応じて最新の情報を確認してください。([公式サイト]((https://developers.google.com/youtube/v3/getting-started?hl=ja)))
- APIキーの取得・本ライブラリの使用等による損失・損害については、一切責任を負いかねますので、公式の情報を確認しつつ自己責任で行ってください。
- 問題・不明点等ありましたら、お気軽にお問い合わせください。

ここまでお付き合いいただきありがとうございました！  
連絡先: [X(Twitter)](https://twitter.com/kanure24)
