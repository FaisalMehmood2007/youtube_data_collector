# 主な機能
本コードで収集できるのは、大きく以下の3つです。
1. [動画のメタデータ](#1-動画のメタデータの収集) : タイトル、概要など (`mode='movie'`)
2. [動画のコメント](#2-動画のコメントの収集) (`mode='comment'`)
3. [動画の統計データ](#3-動画の統計データの収集) : いいね数、視聴数など (`mode='stats'`)

どの機能においても、基本形は以下のようになります。
```
collector = YouTubeDataCollector(
                api_key=YOUTUBE_API_KEY, # どの機能でも同じ
                mode='movie', # 'movie', 'comment', 'stats'のいずれかを指定
                args={} # modeによって異なる
)
collector.run()
```
収集するデータにより異なる点が2つあるので、以下で詳しく説明します。
- `mode`と`args`の指定が異なる
- コメント・統計データを収集する場合は、先に動画のメタデータを収集する必要がある


## 1. 動画のメタデータの収集

argsの中身は以下になります。
- 必須
    - `start` : 取得する動画の開始日時
    - `end` : 取得する動画の終了日時
- 少なくとも1つ必要
    - `query` : 検索クエリ
    - `channel_id` : チャンネルID
- 任意
    - `save` : データを保存するか
    - `save_path` : 保存先のパス

### start / end
まず、取得する動画の開始日時と終了日時を指定する必要があります。ただし、`start`と`end`で単位が同じなら、年・月・日のどれを指定しても取得可能で、その単位ごとにデータが保存されます。

(例)2010年のデータを収集したい場合 (どれでも結果は同じ)
|`start` |`end`|保存単位|保存数*|保存名の例|
|---|---|---|---|---|
|`'2010'`  　　　　　　|`'2010'`　　　　　|年|1  |`キーワード_2010.csv`|
|`'2010-01'`  |`'2010-12'`|月|12  |`キーワード_2010_01.csv`<br>`キーワード_2010_02.csv`|
|`'2010-01-01'`  |`'2010-12-31'`|日|365  |`キーワード_2010_01_01.csv`<br>`キーワード_2010_01_02.csv`|
||

APIが途中で落ちても続きから実行できるように、各単位で取得できるようにしています。長期間のデータを収集する場合は、リクエスト数を減らすためなるべく大きい単位(年・月)を使用してください。

*ここで言う「保存数」は「最低保存ファイル数」です。(詳しくは：[quotaについて](#quotaについて))

### query
次に、`query`・`channel`を指定します。

`query`は自由に設定可能で、複数羅列する場合は半角スペースで区切ります。Twitter API等と同様に、以下のように`AND`や`OR`を用いて検索することもできます。
```
'query': '(今日 OR 明日) AND (晴れ OR 雨)'
```
この例では、「今日・晴れ」を含む動画、「今日・雨」を含む動画、「明日・晴れ」を含む動画、「明日・雨」を含む動画が収集されます。

### channel_id
また、その動画を作成したチャンネル名で取得したい場合もあると思うので、`channel_id`でも指定できるようにしてあります。  
channel_idは、ChannelTitleや「@」で始まるものではなく、そのチャンネルに固有のランダムな英数字です。[こちらの方の記事](https://ilr.jp/tech/485/)でチャンネルURLを入力することで取得できます。

### save
`'save':True`を指定することで、収集したデータを保存することができます。
逆に、`final_df`では、最終データしか保存されない (2010~2021年の場合は2021年のみ)ので、基本的には保存することを推奨します。 (収集データが多すぎて落ちることを防止するため)

また、`save_path`は適宜設定してください。デフォルトは`'./'`(同じ階層に保存)となっています。


## 2. 動画のコメントの収集

argsの中身は以下になります。(先に`mode='movie'`を実行する必要があります。)
- 必須
    - `video_id_list` : 動画IDのリスト
- 任意
    - `save_threshold` : 一定数ごとにデータを保存するかの閾値
    - `save` : データを保存するか
    - `save_path` : 保存先のパス
    - `title` : 保存するファイル名

### video_id_list
`mode`が`comment`か`stats`の場合は、動画を元に収集するので、`start`と`end`の代わりに`video_id_list`が必須となります。
`video_id_list`は、動画収集時に保存したファイル名(or パス)を用いて、以下を実行することで取得できます。
```
path = './クリスマス_2010.csv # ファイル名で指定
# path = './' # save_path # 期間で指定

all_df = collector.read_all_df(path)
video_id_list = collector.pickup_video_id(all_df)
```

ちなみに、収集中にAPIが落ちた場合、収集した最後のvideo_idを元に、以下のように`video_id_list`を更新し、続きから収集することができます。

```
last_id = 'LastSavedVideoId'
video_id_list = collector.update_list(video_id_list, last_id)
```

### save
　もう一つ`mode='movie'`と異なるのは、セーブの方法です。`'movie'`では、1単位ごとに保存していましたが、`'comment'`ではidごとに保存するとフォルダ数が大量になり、まとめて保存すると逆にデータ量が大きくなってしまうため、`save_threshold`ごとに保存するようにしています。デフォルトは300としていますが、フォルダ数をなるべく少なくしたい方は、こちらの数値を大きくしてみてください。また、コメントデータのセーブ名は、`title + "最後のvideo_id"`となるようにしています。このtitleの部分は自由に変更できるので、適宜設定してください。

### コメントデータ例
|comment  |likes |publish_time  |author_id| video_id|
|---|---|---|---|---|
|そんなことあるんだ  |5　　|2010-01-01T01:01:01Z |AAAAAAAAAabbbbbbbCC|ab12cd|
|楽しく見させていただきました！  |2|2013-03-03T03:03:03Z |DDDDDDDeeeeeeeeffffGG|ab12cd|

## 3. 動画の統計データの収集
argsの中身は以下になります。(先に`mode='movie'`を実行する必要があります。)
- 必須
    - `video_id_list` : 動画IDのリスト
- 任意
    - `save` : データを保存するか
    - `save_path` : 保存先のパス
    - `title` : 保存するファイル名

こちらは、基本的に`mode='comment`と同じなので、そちらをご覧ください。ただし、`mode='stats`のときのみ、データ量が比較的小さいので、1つのdataframeとして出力されるようにしてあります。

### 統計データ例
|video_id  |ViewCount  |likeCount  |dislkeCount| commentCount|
|---|---|---|---|---|
|ab12cd|33333 |3|0|1|
|zy34xw|4321 |1|0|0|